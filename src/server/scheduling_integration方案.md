# 排班服务集成需求与技术方案

## 一、需求描述

1. 前端页面传入一个排班ID（schedule_id）。
2. 后端根据该ID，从数据库中获取排班所需的所有参数，包括：
   - 排班配置参数（如成本参数、模拟退火参数等）
   - 班次信息（shifts）
   - 员工信息（employees）
3. 后端将这些参数组装后，调用 Python 排班算法脚本（如 `scheduler_api.py`）。
4. Python 脚本返回排班结果（分配方案、成本、违规统计等）。
5. 后端将排班分配结果写入数据库（如 schedule_assignments 表）。
6. 前端收到排班完成通知后，自动刷新页面，展示最新排班结果。

---

## 二、技术方案

### 1. 接口设计
- 新增后端接口：`POST /api/schedule/run/:id`
  - 参数：`id`（排班ID，URL参数）
  - 返回：排班任务状态、结果或错误信息

### 2. 数据流与处理流程
1. **前端** 触发排班，调用 `/api/schedule/run/:id`。
2. **Node.js后端**：
   - 查询数据库，获取该排班ID对应的所有班次、员工、参数等信息。
   - 组装为 Python 脚本需要的数据结构（JSON）。
   - 通过 `child_process.spawn` 或 `python-shell` 调用 Python 脚本，传入数据。
   - 等待 Python 返回排班结果（可用 stdout 或写临时文件）。
   - 解析结果，将分配写入数据库。
   - 返回排班状态/结果给前端。
3. **前端** 根据接口返回，自动刷新排班结果。

### 3. Python 脚本调用
- 推荐通过 `spawn('python3', ['scheduler_api.py'], ...)` 方式调用。
- 数据通过 stdin/stdout 或临时文件传递。
- Python 需支持接收 JSON 输入和输出。

### 4. 数据库写入
- 设计 schedule_assignments（或类似）表，存储每个班次的人员分配。
- 写入前可先清空该 schedule_id 的旧分配。
- 写入后可更新 schedule 状态为"已排班"。

### 5. 前端刷新
- 前端收到排班完成响应后，自动重新请求排班详情接口，刷新页面。
- 可考虑轮询或 WebSocket 通知（todo）。

---

## 三、关键点与 TODO

- [ ] Python 脚本需支持命令行/标准输入接收参数，并输出JSON结果
- [ ] Node后端需有数据组装、调用、结果解析、异常处理能力
- [ ] 数据库表结构需支持排班分配结果的存储
- [ ] 前端需有自动刷新机制
- [ ] 可扩展为异步任务队列/进度通知（todo）
- [ ] 安全性与错误处理（todo）

---

如需详细接口/表结构/代码示例，请补充说明。 